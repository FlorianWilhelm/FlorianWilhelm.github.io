<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Finally! Bayesian Hierarchical Modelling at Scale - Florian Wilhelm's blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://florianwilhelm.info/2020/10/bayesian_hierarchical_modelling_at_scale/">

        <meta name="author" content="Florian Wilhelm" />
        <meta name="keywords" content="data science,mathematics,production" />
        <meta name="description" content="For a long time, Bayesian Hierarchical Modelling has been a very powerful tool that sadly could not be applied often due to its high computations costs. With NumPyro and the latest advances in high-performance computations in Python, Bayesian Hierarchical Modelling is now ready for prime time." />

        <meta property="og:site_name" content="Florian Wilhelm's blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Finally! Bayesian Hierarchical Modelling at Scale"/>
        <meta property="og:url" content="https://florianwilhelm.info/2020/10/bayesian_hierarchical_modelling_at_scale/"/>
        <meta property="og:description" content="For a long time, Bayesian Hierarchical Modelling has been a very powerful tool that sadly could not be applied often due to its high computations costs. With NumPyro and the latest advances in high-performance computations in Python, Bayesian Hierarchical Modelling is now ready for prime time."/>
        <meta property="article:published_time" content="2020-10-01" />
            <meta property="article:section" content="post" />
            <meta property="article:tag" content="data science" />
            <meta property="article:tag" content="mathematics" />
            <meta property="article:tag" content="production" />
            <meta property="article:author" content="Florian Wilhelm" />

    <meta name="twitter:dnt" content="on">
    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@FlorianWilhelm">
        <meta name="twitter:creator" content="@FlorianWilhelm">
    <meta name="twitter:domain" content="https://florianwilhelm.info">


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://florianwilhelm.info/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://florianwilhelm.info/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://florianwilhelm.info/theme/css/pygments/native.css" rel="stylesheet">
        <link href="https://florianwilhelm.info/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://florianwilhelm.info/theme/css/style.css" type="text/css"/>


        <link href="https://florianwilhelm.info/feeds/post.atom.xml" type="application/atom+xml" rel="alternate"
              title="Florian Wilhelm's blog post ATOM Feed"/>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LQCSE9V2BL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-LQCSE9V2BL');
    </script>
    <!-- End Google Analytics Code -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','');</script>
    <!-- End Google Tag Manager -->

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://florianwilhelm.info/" class="navbar-brand">
Florian Wilhelm's blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/about/">About me</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://florianwilhelm.info/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://florianwilhelm.info/2020/10/bayesian_hierarchical_modelling_at_scale/"
                       rel="bookmark"
                       title="Permalink to Finally! Bayesian Hierarchical Modelling at Scale">
                        Finally! Bayesian Hierarchical Modelling at&nbsp;Scale
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-10-01T08:00:00+02:00"> Oct. 01, 2020</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://florianwilhelm.info/tag/data-science/">data science</a>
        /
	<a href="https://florianwilhelm.info/tag/mathematics/">mathematics</a>
        /
	<a href="https://florianwilhelm.info/tag/production/">production</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>Introduction</h2>
<p>Since the advent of deep learning, everything is or has to be about <em>Artificial Intelligence</em>, so it seems. Even software which is applying traditional
techniques from e.g. instrumentation and control engineering, is nowadays considered <em><span class="caps">AI</span></em>. For instance, the famous robots
of Boston Dynamics are not based on deep reinforcement learning as many people think but much more traditional engineering
methods. This hype around <span class="caps">AI</span>, which is very often equated with deep learning, seems to draw that much attention such that
great advances of more traditional methods seem to go almost completely unnoticed. In this blog post, I want to draw your 
attention to the somewhat dusty <em>Bayesian Hierarchical Modelling</em>. Modern techniques and frameworks allow you to finally apply this
cool method on datasets with sizes much bigger than what was possible before and thus letting it really&nbsp;shine.</p>
<p>So for starters, what is <em>Bayesian Hierarchical Modelling</em> and why should I care? I assume you already have a basic knowledge about
Bayesian inference, otherwise <a href="https://github.com/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers">Probabilistic Programming and Bayesian Methods for Hackers</a>
is a really good starting point to explore the Bayesian rabbit hole. In simple words, Bayesian inference allows you to define
a model with the help of probability distributions and also incorporate your prior knowledge about the parameters of your model.
This leads to a <em>directed acyclic graphical model</em> (aka Bayesian network) which is explainable, visual and easy to reason about.
But that&#8217;s not even everything, you also get <a href="https://en.wikipedia.org/wiki/Uncertainty_quantification">Uncertainty Quantification</a> for free, 
meaning that the model&#8217;s parameters are not mere point estimates but whole distributions telling you how certain you are
about their&nbsp;values. </p>
<p>A classical statistical method that most data scientists learn about early on is <em>linear regression</em>. It can also
be interpreted in a Bayesian way giving you the possibility to define prior knowledge about the parameters, e.g.
that they have to be close to zero or that they are non-negative. Then again, many of the priors you might come up with could also 
be seen as mere regularizers in a non-Bayesian way, and treated like that, often efficient techniques exist to solve such formulations.
So where the Bayesian framework now really shines is, if you consider the following problem setting I stole from the wonderful 
presentation <a href="https://www.youtube.com/watch?v=WbNmcvxRwow">A Bayesian Workflow with PyMC and ArviZ</a> by Corrie&nbsp;Bartelheimer.</p>
<p>Imagine you want to estimate the price of an apartment in Berlin given its living area in square meters and district. Making a linear
regression with all data points you have neglecting the districts, i.e. a <em>pooled model</em>, will lead to a robust estimation of the slope and intercept
but a wide residual distribution. This is due to the fact that the price of an apartment also heavily depends on the district it is
located in. Now grouping your data with respect to the respective districts and making a linear regression for each,
i.e. an <em>unpooled model</em>, will lead to a much more narrow residual distribution but also a high uncertainty in your parameters since
some district might only have three data points. To combine the advantages of a pooled and unpooled model, one
would intuitively demand that for each district the prior knowledge of the parameter from the pooled model should be used
and updated according to the data we have about a certain district. If we have only a few data points we would only allow to
deviate a bit from our prior knowledge about the parameter. In case we have lots of data points, the parameter for the
respective district should be allowed to have a huge difference compared to the parameter of the pooled model. Thus the pooled model
acts as an informed prior for the parameters within the unpooled model leading altogether to an <em>hierarchical model</em>,
which is sometimes also referred to as <em>partially pooled model</em>. Figure 1 illustrates our thoughts so&nbsp;far.</p>
<p>&nbsp;
<figure>
<img class="noZoom" src="/images/hierarchical_model.png" alt="pooled, unpooled, hierarchical model">
<figcaption align="center"><strong>Figure 1:</strong> Hierarchical model as a combination of a pooled and an unpooled model 
from <a href="https://widdowquinn.github.io/Teaching-Stan-Hierarchical-Modelling/07-partial_pooling_intro.html">Bayesian Multilevel Modelling using PyStan</a>.
</figcaption>
</figure>
&nbsp;</p>
<h2>Recent&nbsp;Advances</h2>
<p>So far I mostly used <a href="https://docs.pymc.io/">PyMC3</a> for Bayesian inference or <em>probabilistic programming</em> as the authors
of PyMC3 like to call it. I love it for it&#8217;s elegant design and consequently its expressiveness. The documentation is great
and thus you can pretty much hack away with your model ideas. The only problem I always had with it is that for me it never
scaled so well with somewhat larger datasets, i.e. more than 100k data points, and a larger number of parameters. There is a technical and 
methodical reason for it. Regarding the former, PyMC3 uses <a href="https://github.com/Theano/Theano">Theano</a> to speed
up its computations by transpiling your Python code to C. Theano inspired many frameworks like <a href="https://www.tensorflow.org/">Tensorflow</a> 
and <a href="https://pytorch.org/">PyTorch</a> but is considered deprecated today and cannot rival the speed of modern frameworks
anymore. For the latter, I used PyMC3 mostly with <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov chain Monte Carlo</a> (<span class="caps">MCMC</span>) based methods, 
which are sampling algorithms and thus computationally quite demanding, while <a href="https://en.wikipedia.org/wiki/Variational_Bayesian_methods">variational inference (<span class="caps">VI</span>)</a>
methods are much faster. But also when using <span class="caps">VI</span>, which PyMC3 also supports, it never really allowed me to deal with larger datasets rendering
Bayesian Hierarchical Modelling (<span class="caps">BHM</span>) a wonderful tool that sadly could not be applied in many suitable projects due to its computational&nbsp;costs.</p>
<p>Luckily, the world of data science moves on with an incredible speed, and some time ago I had a nice project at my hand that
could make good use of <span class="caps">BHM</span>. Thus, I gave it another shot and also looked beyond PyMC3. My first candidate to evaluate was <a href="http://pyro.ai/">Pyro</a>,
which uses Stochastic Variational Inference (<span class="caps">SVI</span>) by default, and calls itself a <em>deep universal probabilistic programming</em> framework.
Instead of Theano it is based on PyTorch and thus allows for <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">just-in-time (<span class="caps">JIT</span>) compilation</a>,
which sped up my test case already quite a bit. Pyro also emphasizes vectorization, thus allowing for fast parallel computation, e.g. <a href="https://en.wikipedia.org/wiki/SIMD"><span class="caps">SIMD</span></a> operations.
In total the speed-up compared to PyMC3 was amazing in my test-case letting me almost forget the two downsides of Pyro compared
to PyMC3. Firstly, the documentation of Pyro is not as polished and secondly, it&#8217;s just so much more complicated to use and understand 
but your mileage may vary on that&nbsp;one. </p>
<p>Digging through the website of Pyro I then stumbled over <a href="https://github.com/pyro-ppl/numpyro">NumPyro</a> that has a similar
interface compared to Pyro but uses <a href="https://github.com/google/jax"><span class="caps">JAX</span></a> instead of PyTorch as its backend. <span class="caps">JAX</span> is like <a href="https://numpy.org/">NumPy</a> on 
steroids. It&#8217;s crazy fast as it uses <a href="https://www.tensorflow.org/xla"><span class="caps">XLA</span></a>, which is a domain-specific compiler for linear algebra
operations. Additionally, it allows for automatic differentiation like <a href="https://github.com/hips/autograd">Autograd</a>,
whose maintainers moved over to develop <span class="caps">JAX</span> further. Long story short, NumPyro even blew the benchmark results of Pyro out of the water.
For the first time (at least for what I know), NumPyro allows you do Bayesian inference with lots of parameters like in
<span class="caps">BHM</span> on large data! In the rest of this post, I want to show you how NumPyro can be applied in a typical demand prediction
use-case on some public dataset. The dataset in my actual use-case was much bigger, my model had more parameters and NumPyro could still handle it but you just have to trust me on this one ;-)
Hopefully some readers will find this post useful and maybe it mitigates a bit the pain coming from the lack of NumPyro&#8217;s documentation and&nbsp;examples.</p>
<h2>Use-Case <span class="amp">&amp;</span>&nbsp;Modelling</h2>
<p>Imagine you have many retail stores and want to make individual demand predictions for them. For stores that were opened
a long time ago, this should be no problem but how do you deal with stores that first opened a week ago or even will open soon? Like in the example
of apartment prices in different districts, <span class="caps">BHM</span> helps you to deal exactly with this <a href="https://en.wikipedia.org/wiki/Cold_start_(recommender_systems)">cold start problem</a>. We take the 
<a href="https://www.kaggle.com/c/rossmann-store-sales">Rossmann dataset from Kaggle</a> to simulate this problem by removing the data
of some of the stores. The data consists of a <em>train</em> dataset with information about the sales and daily features of the stores,
e.g. if a promotion happened (<code>promo</code>), as well as a <em>store</em> dataset with time-independent store features.
Here&#8217;s what we wanna do in our little experiment and study&nbsp;protocol:</p>
<ol>
<li>join the data from Kaggle&#8217;s <code>train.csv</code> dataset with the general store features from the <code>store.csv</code> dataset,</li>
<li>perform some really basic feature engineering and encoding of the categorical&nbsp;features,</li>
<li>split the data into train and test where we treat the stores from train as being opened for a long time and the ones
  from test as newly&nbsp;opened,</li>
<li>fit our hierarchical model on the train dataset to infer the &#8220;global&#8221; parameters of the upper model&nbsp;hierarchy,</li>
<li>take only the first 7 days for each store in the test data, which we assume to know, and fit our model only inferring
 the local, i.e. store-specific, parameters of the lower hierarchy while keeping the global ones&nbsp;fixed,</li>
<li>compare the inferred parameters of a test store to:<ol>
<li>the inferred local parameters of a simple Poisson model. We expect them to be completely different due to the lack
   of data and thus overfitting of the Poisson&nbsp;model,</li>
<li>the inferred local parameters of our model if we had given it the whole time series from test, i.e. not only the first 7 days.
   In this case, we assume that we are already pretty close since the priors given by the global parameters nudge them
   in the right direction even with only little&nbsp;data.</li>
</ol>
</li>
</ol>
<p>All code of this little experiment can be found under my <a href="https://github.com/FlorianWilhelm/bhm-at-scale">bhm-at-scale repository</a>
so that you can follow along easily.
The steps 1-3 are performed in the <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/01-preprocessing.ipynb">preprocessing notebook</a>
and are actually not that interesting, thus we will skip it here. Steps 4-6 are performed in the
<a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/02-model.ipynb">model notebook</a> while some visualisations are presented in the <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/03-evaluation.ipynb">evaluation notebook</a>.</p>
<p>But before we start to get technical, let&#8217;s take a minute and frame again the forecasting problem from a more mathematical side.
The data of each store is a time-series of feature vectors and target scalars. We want to find a mapping such that the
feature vector of each time-step is mapped to a value close to the target scalar of the respective time-step. Since our target
value, i.e. the number of sales, is a non-negative integer we could assume a <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson distribution</a> and consequently
perform a <a href="https://en.wikipedia.org/wiki/Poisson_regression">Poisson regression</a> in a hierarchical way. This would be kind of okay
if we were only interested in a point estimation and thus would not care about the variance of the predictive posterior distribution. 
The Poisson distribution only has one parameter <span class="math">\(\lambda\)</span> that allows you to define the mean <span class="math">\(\mu\)</span> while the variance <span class="math">\(\sigma^2\)</span> then just equals the mean as there is no way to adjust the variance independently. <br>
In many practical use-cases, there is <a href="https://en.wikipedia.org/wiki/Overdispersion">overdispersion</a> though, meaning that the variance is larger than the mean and we have to make up for it.
We can define a so called <em>dispersion parameter</em> <span class="math">\(r\in(0,\infty)\)</span> by reparametrization in the <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">negative binomial distribution</a>,&nbsp;i.e.</p>
<div class="math">$$\mathrm{NB}(y;\mu,r) = \frac{\Gamma(r+y)}{y!\cdot\Gamma(r)}\cdot\left(\frac{r}{r+\mu}\right)^r\cdot\left(\frac{\mu}{r+\mu}\right)^y,$$</div>
<p>where <span class="math">\(\Gamma\)</span> is the <a href="https://en.wikipedia.org/wiki/Gamma_function">Gamma function</a>. Now we&nbsp;have</p>
<div class="math">$$\sigma^2=\mu + \frac{1}{r}\mu^2$$</div>
<p>and using <span class="math">\(r\)</span> we are thus able to adjust the variance from <span class="math">\(\mu\)</span> to <span class="math">\(\infty\)</span>. 
Another name for the negative binomial distribution is Gamma-Poisson distribution and this is the name under which we find it also in NumPyro. I find this name 
much more catchy since you can imagine a Poisson distribution with its only parameter drawn from a Gamma distribution that
has two parameters <span class="math">\(\alpha\)</span> and <span class="math">\(\beta\)</span>. This also intuitively explains why the variance of <span class="caps">NB</span> is bounded below by its mean.
Just think of <span class="caps">NB</span> as a generalization of the Poisson distribution with one more parameter that allows adjusting the&nbsp;variance.</p>
<p>Uncertainty Quantification is a crucial requirement for demand forecasts in retail although peculiarly, no one really cares about forecasts in retail anyway.
What retailers really care about is optimal replenishment, meaning that they want to have a system telling them how much
to order so that there is an optimal amount of stocks available in their store. In order to provide optimal replenishment
suggestions you need demand forecasts that provide probability distributions, not only point estimations. With the help
of those distributions the replenishment system basically runs an optimization with respect to some cost function, e.g.
cost of a missed sale is weighted 3 times the cost of a written-off product, and further constraints, e.g. if products can only be ordered in bundles of 10. 
For these reasons we will use the <span class="caps">NB</span> distribution that allows us the quantify the uncertainties in our sales predictions&nbsp;adequately.</p>
<p>So now that we settled with <span class="caps">NB</span> as the distribution that we want to fit to the daily sales of our stores <span class="math">\(\mathbf{y}\)</span>, we can think
about incorporating our features <span class="math">\(\mathbf{x}\)</span>. We want to use a linear model to map <span class="math">\(\mathbf{x}\)</span> to <span class="math">\(\mathbf{\mu}\)</span> such
that we can use it later to calculate <span class="math">\(\alpha\)</span> and <span class="math">\(\beta\)</span> of <span class="caps">NB</span>. Using again the fact that we are dealing with non-negative
numbers and also considering that we expect effects to be multiplicative, e.g. 10% more during a promotion, our ansatz&nbsp;is</p>
<div class="math">$$\mu = \exp(\mathbf{\theta}^\top\mathbf{x}),$$</div>
<p>where <span class="math">\(\mathbf{\theta}\)</span> is a vector of coefficients. For each store <span class="math">\(i\)</span> and each feature <span class="math">\(j\)</span> we will have a separate
coefficient <span class="math">\(\theta_{ij}\)</span>. The <span class="math">\(\theta_{ij}\)</span> are regularized by parameters <span class="math">\(\theta^\mu_j\)</span> and <span class="math">\(\theta^{\sigma^2}_j\)</span> on 
the global level, which helps us in case a store has only little historical data. For the dispersion parameters we
infer individual <span class="math">\(r_i\)</span> for each store <span class="math">\(i\)</span> as well as global parameters <span class="math">\(r^\mu\)</span> and <span class="math">\(r^{\sigma^2}\)</span> over all stores. 
And that&#8217;s already most of it. Figure 2 depicts the graphical model outlined so&nbsp;far.</p>
<figure>
<p align="center">
<img class="noZoom" src="/images/bhm_model.png" alt="centered hierarchical model" width="60%">
</p>
<figcaption align="center">
<strong>Figure 2:</strong> Graphical representation of a hierarchical model (centered version) as defined above.
</figcaption>
</figure>

<p>&nbsp;</p>
<p>Those boxes in Figure 2, which are called <a href="https://en.wikipedia.org/wiki/Plate_notation">plates</a>, tell you how many times a parameter is repeated.
Nested plates are multiplied by the number given by outer plates, which can also be seen by looking at the number of indices.
The concept of plates was also taken up by the authors of NumPyro to express that certain dimensions are conditionally independent.
This also helps them to increase performance by taking optimizations into account that are just not possible in the general case.
Shaded circles are observed values, which in our case are the number of sales on a given day <span class="math">\(k\)</span> and store <span class="math">\(i\)</span>.</p>
<h2>Implementation</h2>
<p>Let&#8217;s take a quick look into our model code which is just a normal Python function. It&#8217;s good to keep in mind, that we call this a <em>model</em> since we assume that given
the right parameters it would be able to generate sales for some given stores and days resembling the observed sales for these stores and days.
The model function only defines the model parameters, how they interact and their&nbsp;priors.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.infer.reparam</span> <span class="kn">import</span> <span class="n">TransformReparam</span>
<span class="kn">from</span> <span class="nn">jax.numpy</span> <span class="kn">import</span> <span class="n">DeviceArray</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>


<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">DeviceArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeviceArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gamma-Poisson hierarchical model for daily sales forecasting</span>

<span class="sd">    Args:</span>
<span class="sd">        X: input data</span>

<span class="sd">    Returns:</span>
<span class="sd">        output data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_stores</span><span class="p">,</span> <span class="n">n_days</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_features</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># remove one dim for target</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-12</span>  <span class="c1"># epsilon</span>

    <span class="n">plate_features</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plate_stores</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;stores&quot;</span><span class="p">,</span> <span class="n">n_stores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plate_days</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;timesteps&quot;</span><span class="p">,</span> <span class="n">n_days</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">disp_param_mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;disp_param_mu&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">disp_param_sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;disp_param_sigma&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">plate_stores</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;disp_params&quot;</span><span class="p">:</span> <span class="n">TransformReparam</span><span class="p">()}):</span>
            <span class="n">disp_params</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;disp_params&quot;</span><span class="p">,</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">disp_param_mu</span><span class="p">,</span> <span class="n">disp_param_sigma</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

    <span class="k">with</span> <span class="n">plate_features</span><span class="p">:</span>
        <span class="n">coef_mus</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="s2">&quot;coef_mus&quot;</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_features</span><span class="p">),</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_features</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">coef_sigmas</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="s2">&quot;coef_sigmas&quot;</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_features</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">plate_stores</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefs&quot;</span><span class="p">:</span> <span class="n">TransformReparam</span><span class="p">()}):</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;coefs&quot;</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">coef_mus</span><span class="p">,</span> <span class="n">coef_sigmas</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>

    <span class="k">with</span> <span class="n">plate_days</span><span class="p">,</span> <span class="n">plate_stores</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># padded features to 0</span>
        <span class="n">is_observed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">targets</span><span class="p">))</span>
        <span class="n">not_observed</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">is_observed</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_observed</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                 <span class="o">+</span> <span class="n">not_observed</span><span class="o">*</span><span class="n">eps</span><span class="p">)</span>

        <span class="n">betas</span> <span class="o">=</span> <span class="n">is_observed</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">disp_params</span><span class="p">)</span> <span class="o">+</span> <span class="n">not_observed</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">means</span> <span class="o">*</span> <span class="n">betas</span>
        <span class="k">return</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;days&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">GammaPoisson</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">betas</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">targets</span><span class="p">))</span>
</pre></div>


<p>Note that <code>disp_param</code> is <span class="math">\(r\)</span> and <code>coef</code> is <span class="math">\(\theta\)</span> in the source code above for better readability. You will
recognize a lot of what we have talked about and I don&#8217;t want to go into the syntactical details of NumPyro. My suggestion
would be to first read the documentation of Pyro, as it is way more comprehensive, and then look up the differences in the
NumPyro&nbsp;reference. </p>
<p>Reading the source code more thoroughly, you might wonder about the definition of the coefficients&nbsp;as:</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefs&quot;</span><span class="p">:</span> <span class="n">TransformReparam</span><span class="p">()}):</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;coefs&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">coef_mus</span><span class="p">,</span> <span class="n">coef_sigmas</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
</pre></div>


<p>The explanations of the model I have given and also the plot, actually shows the <em>centered version</em> of a
hierarchical model. For me the centered version feels much more intuitive and is easier to explain. The downside is that
the direct dependency of the local parameters on the global ones make it hard for many <span class="caps">MCMC</span> sampling methods but also <span class="caps">SVI</span> methods to explore
certain regions of the local parameter space. This effect is called <em>funnel</em> and can be imagined as walking with the the same step length
on a bridge that gets narrower and narrower. From the point on where the bridge is about as wide as your step length, you might
become a bit hesitant to explore more of it. As very often the case, a reparameterization overcomes this problem resulting
in the <em>non-centered</em> version of a hierarchical model. This is the version used in the implementation. If you want to know more about this, a really great 
<a href="https://twiecki.io/blog/2017/02/08/bayesian-hierchical-non-centered/">blog post by Thomas Wiecki</a> gives you all the details about&nbsp;it.</p>
<p>Another thing that wasn&#8217;t mentioned yet are the <code>is_observed</code> and <code>not_observed</code> variables which are just a nice gimmick.
Instead of using up degrees of freedom to learn that the number of sales is 0 on days where the store is closed, I set
the target variable <span class="math">\(y\)</span> to <em>not observed</em> instead of 0. During training, these target values are just ignored and later
allows the model to answer a store manager&#8217;s potential question: &#8220;How many sales would I have had if I had opened my store on that&nbsp;day?&#8221;</p>
<p>Until now we have talked about the model and if you are a PyMC3 user, you might think that this should be enough to actually solve it.
Pyro and NumPyro have a curious difference with respect to that. To actually fit the parameters of the model, distributions for the 
parameters have to be defined since its <span class="caps">SVI</span>. This is done in a separate function called <em>guide</em>. </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">guide</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">DeviceArray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guide with parameters of the posterior</span>

<span class="sd">    Args:</span>
<span class="sd">        X: input data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_stores</span><span class="p">,</span> <span class="n">n_days</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_features</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># remove one dim for target</span>

    <span class="n">plate_features</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plate_stores</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;stores&quot;</span><span class="p">,</span> <span class="n">n_stores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">disp_param_mu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;disp_param_mu&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;loc_disp_param_mu&quot;</span><span class="p">,</span> <span class="mf">4.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;scale_disp_param_mu&quot;</span><span class="p">,</span> <span class="mf">1.</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                        <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">disp_param_sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;disp_param_sigma&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;loc_disp_param_logsigma&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;scale_disp_param_logsigma&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                            <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">)),</span>
            <span class="n">transforms</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ExpTransform</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">plate_stores</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;disp_params&quot;</span><span class="p">:</span> <span class="n">TransformReparam</span><span class="p">()}):</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;disp_params&quot;</span><span class="p">,</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;loc_disp_params&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;scale_disp_params&quot;</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                            <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">disp_param_mu</span><span class="p">,</span> <span class="n">disp_param_sigma</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

    <span class="k">with</span> <span class="n">plate_features</span><span class="p">:</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="s2">&quot;coef_mus&quot;</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;loc_coef_mus&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_features</span><span class="p">)),</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;scale_coef_mus&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_features</span><span class="p">),</span>
                                            <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="s2">&quot;coef_sigmas&quot;</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;loc_coef_logsigmas&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_features</span><span class="p">)),</span>
                            <span class="n">scale</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;scale_coef_logsigmas&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_features</span><span class="p">),</span>
                                                <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">)),</span>
                <span class="n">transforms</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ExpTransform</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">plate_stores</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">reparam</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefs&quot;</span><span class="p">:</span> <span class="n">TransformReparam</span><span class="p">()}):</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;coefs&quot;</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
                            <span class="n">loc</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;loc_coefs&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="n">n_features</span><span class="p">))),</span>
                            <span class="n">scale</span><span class="o">=</span><span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;scale_coefs&quot;</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_stores</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)),</span>
                                                <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">coef_mus</span><span class="p">,</span> <span class="n">coef_sigmas</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
</pre></div>


<p>As you can see, the structure of the guide reflects the structure of the model and there we are just defining for each model parameter
a distribution that again has parameters that need to be determined. The link between model and guide is given by the names of the <em>sample sites</em>
like &#8220;coef_offsets&#8221;. This is a bit dangerous as a single typo in the model or guide may break this link leading to unexpected
behaviour. I spent more than a day of debugging a model once until I realized that some sample site in the guide had a typo.
You can see in the actual implementation, i.e. <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/src/bhm_at_scale/model.py">model.py</a>, that I learnt from my mistakes as this source of error can be completely eliminated by simply defining class variables&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Site</span><span class="p">:</span>
    <span class="n">disp_param_mu</span> <span class="o">=</span> <span class="s2">&quot;disp_param_mu&quot;</span>
    <span class="n">disp_param_sigma</span> <span class="o">=</span> <span class="s2">&quot;disp_param_sigma&quot;</span>
    <span class="n">disp_param_offsets</span> <span class="o">=</span> <span class="s2">&quot;disp_param_offsets&quot;</span>
    <span class="n">disp_params</span> <span class="o">=</span> <span class="s2">&quot;disp_params&quot;</span>
    <span class="n">coef_mus</span> <span class="o">=</span> <span class="s2">&quot;coef_mus&quot;</span>
    <span class="n">coef_sigmas</span> <span class="o">=</span> <span class="s2">&quot;coef_sigmas&quot;</span>
    <span class="n">coef_offsets</span> <span class="o">=</span> <span class="s2">&quot;coef_offsets&quot;</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="s2">&quot;coefs&quot;</span>
    <span class="n">days</span> <span class="o">=</span> <span class="s2">&quot;days&quot;</span>
</pre></div>


<p>Then using variables like <code>Site.coef_offsets</code> instead of strings like <code>"coef_offsets"</code> as identifiers of sample sites, allows your <span class="caps">IDE</span> to inform you about any typo as you go. Problem&nbsp;solved.</p>
<p>Besides the model and guide, we also have to define a local guide and a predictive model. The local guide assumes
that we have already fitted the global parameters but want to only determine the local parameters of new stores with little data.
The predictive model assumes global and local parameters to be already inferred so that we can use it to predict the number
of sales on days beyond our training interval. As these functions are only slide variations, I spare you the details and refer you to the implementation in <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/src/bhm_at_scale/model.py">model.py</a>.</p>
<p>Most parts of the <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/02-model.ipynb">model notebook</a> actually deal with training the model on stores from the training data with a long sales history,
then fixing the global parameters and fitting the local guide on the stores from the test set with a really short history of 7 days.
This works really well although the number of features, which is 23, is much higher than 7! Let&#8217;s take a look at the coefficients 
of a store from the test set as detailed in the <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/02-model.ipynb">model notebook</a>:</p>
<div class="highlight"><pre><span></span>[ 2.7901888   2.6591218   2.6881874   2.6126788   2.656775    2.554397
  2.4938385   0.33227605  3.115691    2.9264386   2.692092    2.9548435
  0.05613964  0.06542112  2.8379264   2.9023972   3.5701406   3.2074358
  4.0569873   2.9304545   2.7463424   2.823191    2.959007  ]
</pre></div>


<p>The notebook also shows that the traditional Poisson regression using Scikit-Learn overfits the training set and yields implausible coefficients. 
Comparing the coefficients from above to the ones of the Poisson regression for the same store,&nbsp;i.e.</p>
<div class="highlight"><pre><span></span>[ 1.1747563  -2.2386415   2.1442924   1.9889396   1.9385103   1.8024149
 -6.8102717   1.1747563   2.2386413  -2.2386413   0.          0.
 -0.09434899  0.          0.          0.          0.          0.
  0.          0.          0.          0.          0.        ]
</pre></div>


<p>we see that they are highly different and zero for features in the Poisson regression that weren&#8217;t encountered in the data of just 7 days.
Now comparing the coefficients of our <span class="caps">BHM</span> model trained on just 7 days with the coefficients of a cheating model trained on the whole test set,&nbsp;i.e.</p>
<div class="highlight"><pre><span></span>[ 2.814997    2.7551868   2.6182172   2.6453698   2.672692    2.5201027
  2.593036    0.2265296   3.184446    3.1163387   2.5429602   2.9477317
 -0.03218627  0.06836608  2.8726482   2.925492    3.56679     3.215817
  4.0523443   2.9164758   2.7241356   2.8247747   2.9598234 ]
</pre></div>


<p>we see that they are quite similar. That&#8217;s the magic of a hierarchical model! We started with plausible defaults from a 
global perspective and adapted locally depending on the amount of available&nbsp;data.</p>
<p>Running the code from the <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/02-model.ipynb">model notebook</a> on your laptop will be matter of a few minutes for the training on 1000 stores
each having 942 days of sales and 23 features for each store and day. In total this leads to roughly one million data points
and <span class="math">\(23\cdot 1000+1000+2\cdot 23+2=24048\)</span> parameters in our graphical model. Since each parameter is fitted with the help of a 
parameterized distribution in the guide, as we are doing <span class="caps">SVI</span>, the number of actual variables is twice as much leading to roughly 50,000
variables that need to be fitted. While 50k parameters and about 1 Million data points surely is not big data, 
it&#8217;s still impressive that using NumPyro you can fit a model like that within a few minutes on your
laptop and the implementation is not even using batching that would speed it up even further. In one of my customer
projects we used a way larger model on much more data and our workstation was still able to handle it smoothly. 
NumPyro really scales well even beyond this little&nbsp;demonstration. </p>
<h2>Visualization</h2>
<p>There is now tons of things one could do with the results of our hierarchical model. One could check out the
actual prediction results, look at how certain we are about the parameters like the coefficients and so on. Most of that
I will leave to the interested reader and give only a few tidbits here from the <a href="https://github.com/FlorianWilhelm/bhm-at-scale/blob/master/notebooks/03-evaluation.ipynb">evaluation notebook</a>.
We start with taking a look at the sales prediction for one of the stores from the test set as depicted in Figure&nbsp;3.</p>
<figure>
<p align="center">
<img class="noZoom" src="/images/bhm_sales_forecast.png" alt="plot of sales forecast">
</p>
<figcaption align="center">
<strong>Figure 3:</strong> Sales forecast of one store from the test set. The blue dashed line is the the mean predicted mean.
</figcaption>
</figure>

<p>&nbsp;</p>
<p>Only judging by the eye, we see that predicted mean (blue dashed line) follows the number of sales (bluish bars) quite good.
The background is shaded according to some important features like promotions and holidays which explain some of the variations
in our predictions. Just for information, also the number of customers are displayed but not used in the prediction of course.
Also, we see the 50% and 90% <a href="https://en.wikipedia.org/wiki/Credible_interval">credible intervals</a> as shaded blue areas
around our mean, which tell us how certain we are about our predictions. We can also see that on Sundays, when the store
was closed, we predict not 0 but what would have likely happened if it wasn&#8217;t closed, which was part of our&nbsp;model.</p>
<p>We could then also start looking into the effects of certain features like the weekdays. Figure 4 shows for each
weekday starting with Monday a density over the means of all&nbsp;stores. </p>
<figure>
<p align="center">
<img class="noZoom" src="/images/bhm_weekday_effect.png" alt="plot weekday effect">
</p>
<figcaption align="center">
<strong>Figure 4:</strong> Density plot of the means of the weekday coefficients over all stores. 
</figcaption>
</figure>

<p>&nbsp;</p>
<p>We can see that on average there seem to be a higher sales uplift on Mondays and also a high variance for the means on Saturdays and
Sundays when many stores are closed. If we are more interested in things we can change, like when to do a promotion,
we could be interested in analyzing the distribution of the promotion effect over all stores as shown in Figure&nbsp;5.  </p>
<figure>
<p align="center">
<img class="noZoom" src="/images/bhm_promo_effect.png" alt="plot of promotion effect">
</p>
<figcaption align="center">
<strong>Figure 5:</strong> Density plot of the promotion effect over all stores with the red line showing the median.
</figcaption>
</figure>

<p>&nbsp;</p>
<p>These are just some analysis one could start to look into to derive useful insights for store management. 
The rest is up to your imagination and also depending on your use-case. Imagine we had a dataset that features not 
only the aggregated sales but also the ones of individual products, i.e. <a href="https://en.wikipedia.org/wiki/Stock_keeping_unit"><span class="caps">SKU</span>-level</a>. We could then build hierarchies over the product hierarchies
and thus addressing cannibalization effects, e.g. when we introduce a new type of wine within our current offering.
We could also use <span class="caps">BHM</span> to address <a href="https://en.wikipedia.org/wiki/Censoring_(statistics)">censored data</a>, which is also an important task when doing demand forecasts. So far we have
used the words sales forecast and demand forecast interchangeably but bear in mind that we are actually interested in the demand.
Canonically, one assumes that the demand for a product equals its sales but this only holds true if there was no out-of-stock situation
in which we only know that demand ≥ sales. Right-censored data like that provides us with information about the <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">cumulative
distribution function</a> in contrast to the <a href="https://en.wikipedia.org/wiki/Probability_mass_function">probability mass function</a>
in case of no out-of-stock situation. There are ways to include both types of information into a <span class="caps">BHM</span>.
Those are just some of many possible improvements and extensions to this model. I am looking forward to your ideas and&nbsp;use-cases!</p>
<h2>Final&nbsp;Remarks</h2>
<p>We have seen that <span class="caps">BHM</span> allows us to combine the advantages of a pooled and unpooled model. Using some retailer&#8217;s data,
we implemented a simple <span class="caps">BHM</span> thereby also outlining the advantages of a Bayesian approach like uncertainty quantification and
explainability. From a practical perspective, we have seen that <span class="caps">BHM</span> even scales really well with the help of NumPyro.
On the theoretical side, we have talked about the Poisson distribution and why we preferred the Gamma-Poisson distribution.
Finally, I hope to have conveyed the most important point of this post well, being that these models can now be applied to
practical dataset sizes with the help of NumPyro! Cheers to that and let&#8217;s follow a famous saying in the French world of mathematics <em>Poisson sans boisson est poison</em>! </p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js','color.js'], equationNumbers: { autoNumber: 'auto' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://florianwilhelm.info/2022/10/forget_about_ai_and_do_mathematical_modelling_instead/">Forget about <span class="caps">AI</span> and do Mathematical Modelling&nbsp;instead!</a></li>
        <li><a href="https://florianwilhelm.info/2021/08/using_bigquery_with_programmatic_sql/">Using Google BigQuery with Programmatic <span class="caps">SQL</span></a></li>
        <li><a href="https://florianwilhelm.info/2020/05/honey_i_shrunk_the_target_variable/">Honey, I shrunk the target&nbsp;variable</a></li>
        <li><a href="https://florianwilhelm.info/2018/07/bridging_the_gap_from_ds_to_prod/">Bridging the Gap: from Data Science to&nbsp;Production</a></li>
        <li><a href="https://florianwilhelm.info/2018/07/how_mobilede_brings_ds_to_prod_for_a_personalized_web_experience/">How mobile.de brings Data Science to Production for a Personalized Web&nbsp;Experience</a></li>
    </ul>
</section>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'florianwilhelmblog'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2020-10-01-bayesian_hierarchical_modelling_at_scale';
                        this.page.url = 'https://florianwilhelm.info/2020/10/bayesian_hierarchical_modelling_at_scale/';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://twitter.com/FlorianWilhelm"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
    <li class="list-group-item"><a href="https://linkedin.com/in/florian-wilhelm-621ba834"><i class="fa fa-linkedin-square fa-lg"></i> LinkedIn</a></li>
    <li class="list-group-item"><a href="https://github.com/FlorianWilhelm"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="https://florianwilhelm.info/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/ai/">ai</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/airbyte/">airbyte</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/asynchronous/">asynchronous</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/asyncio/">asyncio</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/bayesian/">bayesian</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/big-data/">big data</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/bokeh/">bokeh</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/causal-inference/">causal inference</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/conference/">conference</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/configuration/">configuration</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://florianwilhelm.info/tag/data-science/">data science</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/dbt/">dbt</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/deep-learning/">deep learning</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/event-driven/">event-driven</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/gans/">GANs</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/google-hangouts/">google hangouts</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/gps/">gps</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/hadoop/">hadoop</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/hive/">hive</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/jupyter/">jupyter</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/kalman-filter/">kalman filter</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/lightdash/">lightdash</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/machine-learning/">machine-learning</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/mathematics/">mathematics</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/nlp/">nlp</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://florianwilhelm.info/tag/predictive-analytics/">predictive analytics</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/production/">production</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://florianwilhelm.info/tag/programming/">programming</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://florianwilhelm.info/tag/python/">Python</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://florianwilhelm.info/tag/recommender-systems/">recommender systems</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/scikit-learn/">scikit-learn</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/scipy/">scipy</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/semi-supervised/">semi-supervised</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/snowflake/">Snowflake</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/spark/">spark</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/template/">template</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/uncertainty-quantification/">uncertainty quantification</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2023 Florian Wilhelm
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://florianwilhelm.info/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://florianwilhelm.info/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://florianwilhelm.info/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'florianwilhelmblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->


<script>
   $(document).ready(function () {
      $("table").attr("class","table table-condensed table-bordered");
   });
</script>
</body>
</html>