<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Using Google BigQuery with Programmatic SQL - Florian Wilhelm's blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://florianwilhelm.info/2021/08/using_bigquery_with_programmatic_sql/">

        <meta name="author" content="Florian Wilhelm" />
        <meta name="keywords" content="python,production,data science" />
        <meta name="description" content="An often encountered Antipattern in Python code are complex queries composed with the help of string substitutions and concatenations. SQLAlchemy Core allows you to generate queries in a programmatic way for many SQL databases like BigQuery." />

        <meta property="og:site_name" content="Florian Wilhelm's blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Using Google BigQuery with Programmatic SQL"/>
        <meta property="og:url" content="https://florianwilhelm.info/2021/08/using_bigquery_with_programmatic_sql/"/>
        <meta property="og:description" content="An often encountered Antipattern in Python code are complex queries composed with the help of string substitutions and concatenations. SQLAlchemy Core allows you to generate queries in a programmatic way for many SQL databases like BigQuery."/>
        <meta property="article:published_time" content="2021-08-08" />
            <meta property="article:section" content="post" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="production" />
            <meta property="article:tag" content="data science" />
            <meta property="article:author" content="Florian Wilhelm" />

    <meta name="twitter:dnt" content="on">
    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@FlorianWilhelm">
        <meta name="twitter:creator" content="@FlorianWilhelm">
    <meta name="twitter:domain" content="https://florianwilhelm.info">


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://florianwilhelm.info/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://florianwilhelm.info/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://florianwilhelm.info/theme/css/pygments/native.css" rel="stylesheet">
        <link href="https://florianwilhelm.info/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://florianwilhelm.info/theme/css/style.css" type="text/css"/>


        <link href="https://florianwilhelm.info/feeds/post.atom.xml" type="application/atom+xml" rel="alternate"
              title="Florian Wilhelm's blog post ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://florianwilhelm.info/" class="navbar-brand">
Florian Wilhelm's blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/about/">About me</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://florianwilhelm.info/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://florianwilhelm.info/2021/08/using_bigquery_with_programmatic_sql/"
                       rel="bookmark"
                       title="Permalink to Using Google BigQuery with Programmatic SQL">
                        Using Google BigQuery with Programmatic <span class="caps">SQL</span>
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2021-08-08T08:00:00+02:00"> Aug. 08, 2021</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://florianwilhelm.info/tag/python/">python</a>
        /
	<a href="https://florianwilhelm.info/tag/production/">production</a>
        /
	<a href="https://florianwilhelm.info/tag/data-science/">data science</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>Introduction</h2>
<p>Especially in data science projects, Python code is often peppered with functions generating <span class="caps">SQL</span> queries as strings&nbsp;like:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_sku_ts</span><span class="p">(</span><span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compose query to retrieve timeseries for SKU or list of SKUs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT *</span>
<span class="s2">    FROM `sku-table`</span>
<span class="s2">    WHERE entity_id = </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; AND sku = </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">sku</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">list_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sku</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; AND sku IN (</span><span class="si">{</span><span class="n">list_str</span><span class="si">}</span><span class="s2">) &quot;</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ORDER BY date ASC</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">query</span>
</code></pre></div>

<p>And this is even only a simple example. Using dynamic joins and sub-queries, things can get even more complicated.
When the Python on-board resources are no longer sufficient, some developers start using templating engines like <a href="https://jinja.palletsprojects.com/">Jinja</a>
to handle the complexity of generating a query string&nbsp;dynamically. </p>
<p>But is string generation really the right way to solve a problem like that? It&#8217;s definitely easy as most developers in
the field of data science know their <span class="caps">SQL</span> and dealing with strings, so it&#8217;s a start with low entry hurdle. Let&#8217;s shed some
light on the downsides of this approach. The first thing to note is that we have a language break as we use <span class="caps">SQL</span> and Python
side-by-side in the same program. This causes us some trouble as we never know if the queries we generate are even 
syntactically valid. Only at execution time we will see if the <span class="caps">SQL</span> parsers swallows what we generated which makes unit testing
such functions quite hard. Without an <span class="caps">SQL</span> parser, we can only test in the function above if different kinds of parameters lead
to some string, which is trivial. Another impact of the language break is that structuring and decoupling the code becomes harder.
Imagine you want to write one method that takes another query and adds time-based slicing by specifying two dates. If
the query is a string this will be pretty hard as you need to add some <code>DATE(timestamp) BETWEEN FROM_DATE AND TO_DATE</code>-clause
and there might be already some other where-clauses specified. A last downside is that specifying <span class="caps">SQL</span> queries like
this is quite prone to <a href="https://en.wikipedia.org/wiki/SQL_injection"><span class="caps">SQL</span> injection attacks</a>. So if you compose your queries based on user-generated data, e.g. user input
from some e-commerce website, a malicious user might inject sub-queries in a smart way to steal your data. In many data science
related projects this might be a rather academic vector of attack, but especially in learning-to-rank use-cases it might not
be that&nbsp;unrealistic.</p>
<p>To summarize these&nbsp;downsides:</p>
<ol>
<li>language gap between Python and <span class="caps">SQL</span>, i.e. no <span class="caps">IDE</span>-support to find errors before&nbsp;execution, </li>
<li>hard to write clean, decoupled, well-structured code and meaningful unit&nbsp;tests,</li>
<li>the possibility of <span class="caps">SQL</span> injection&nbsp;attacks.</li>
</ol>
<h2>Programmatic <span class="caps">SQL</span></h2>
<p><span class="dquo">&#8220;</span>But <span class="caps">SQL</span> is the right tool for this task! So what&#8217;s the solution then?&#8221;, I hear you mutter. Welcome to programmatic <span class="caps">SQL</span>!
And it might not even be new to you if you have ever used <a href="https://spark.apache.org/">Apache Spark</a>. In Spark you have many frontends besides the <span class="caps">SQL</span> <span class="caps">API</span>, 
like PySpark for Python and others for Java, Scala, R, etc. Most data scientists naturally use a 
programmatic approach in their programs avoiding the downsides of <span class="caps">SQL</span> string generation without even&nbsp;noticing. </p>
<p>But what if we are dealing not with Spark but another database or warehouse like <a href="https://cloud.google.com/bigquery">BigQuery</a>? In this case we can
use <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>! SQLAlchemy comes with two abstraction layers, a <em>Core</em> layer and a high-level <em><span class="caps">ORM</span></em> layer. <span class="caps">ORM</span> stands for
Object-Relational Mapping and is a common technique to define objects that are automatically mapped to a relational database. 
For most data science projects it&#8217;s not so useful as typical use-cases are analytical and are thus not focused on single instances/objects. 
The underrated Core layer of SQLAlchemy, on the other hand, is really useful as it provides us with a way of generating queries programmatically similar to PySpark.
SQLAlchemy is independent of the actual <span class="caps">SQL</span> dialect and by installing a corresponding dialect it can deal with all popular
databases and data warehouses, for instance MySQL, PostgreSQL, BigQuery, etc.
So how does this work? Let&#8217;s go through this with a BigQuery example as it is often used in data science&nbsp;projects.</p>
<h2>SQLAlchemy with&nbsp;BigQuery</h2>
<p>Let&#8217;s say we want to find out how many monthly downloads some project on <a href="https://pypi.org/">PyPI</a> has. If you want to follow along and
try it out yourself, a Jupyter notebook is available on my <a href="https://github.com/FlorianWilhelm/bigquery-programmatic-sql">Github repository</a>. </p>
<p>With plain <span class="caps">SQL</span>, we would solve this task the following&nbsp;way:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span>

<span class="n">bqclient</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>

<span class="n">query_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT </span>
<span class="s2">  DATE_TRUNC(DATE(timestamp), MONTH) AS `month`,</span>
<span class="s2">  COUNT(*) AS num_downloads,</span>
<span class="s2">FROM `bigquery-public-data.pypi.file_downloads`</span>
<span class="s2">WHERE file.project = &#39;pyscaffold&#39;</span>
<span class="s2">    AND details.installer.name = &#39;pip&#39;</span>
<span class="s2">    AND DATE(timestamp) BETWEEN DATE(&#39;2021-01-01&#39;) AND CURRENT_DATE()</span>
<span class="s2">GROUP BY `month`</span>
<span class="s2">ORDER BY `month`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">bqclient</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
    <span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">create_bqstorage_client</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p>Quite easy, but note that to keep this example focused, the query string is static, meaning that in order to dynamically
change the time slicing, the project name etc., we would have to introduce string substitutions at least. This would
result in the aforementioned&nbsp;downsides.</p>
<p>In contrast to that, after having installed <a href="https://www.sqlalchemy.org/">SQLAlchemy</a> and the BigQuery dialect <a href="https://pypi.org/project/pybigquery/">pybigquery</a>, we can define a 
dynamic <code>query</code> object instead of <code>query_string</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">func</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;bigquery://my_gcp_project&#39;</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;bigquery-public-data.pypi.file_downloads&#39;</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">),</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">date_trunc</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)),</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">),</span>
            <span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;num_downloads&quot;</span><span class="p">)],</span>
           <span class="n">from_obj</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">and_</span><span class="p">(</span>
            <span class="n">F</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">current_date</span><span class="p">()),</span>
            <span class="n">column</span><span class="p">(</span><span class="s2">&quot;file.project&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pyscaffold&quot;</span><span class="p">,</span>
            <span class="n">column</span><span class="p">(</span><span class="s2">&quot;details.installer.name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pip&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p>At first sight, it looks somewhat more verbose and unfamiliar, but you will get used to the SQLAlchemy <span class="caps">API</span>, even if 
it doesn&#8217;t look as concise as the one of PySpark, I have to admit. More or less, it&#8217;s just <span class="caps">SQL</span> but embedded nicely as functions and objects in&nbsp;Python.</p>
<p>So far, we have only generated the query and SQLAlchemy would have directly informed us if this was invalid. To see how
the prepared <span class="caps">SQL</span> statement looks like, maybe for debugging, we can just <code>print(query)</code> to&nbsp;get:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="n">date_trunc</span><span class="p">(</span><span class="nb">date</span><span class="p">(</span><span class="o">`</span><span class="k">timestamp</span><span class="o">`</span><span class="p">),</span> <span class="k">month</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="k">month</span><span class="o">`</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">count_1</span><span class="p">:</span><span class="n">STRING</span><span class="p">)</span><span class="n">s</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">num_downloads</span><span class="o">`</span> 
<span class="k">FROM</span> <span class="o">`</span><span class="n">bigquery</span><span class="o">-</span><span class="k">public</span><span class="o">-</span><span class="k">data</span><span class="p">.</span><span class="n">pypi</span><span class="p">.</span><span class="n">file_downloads</span><span class="o">`</span> 
<span class="k">WHERE</span> <span class="nb">date</span><span class="p">(</span><span class="o">`</span><span class="k">timestamp</span><span class="o">`</span><span class="p">)</span> <span class="k">BETWEEN</span> <span class="o">%</span><span class="p">(</span><span class="n">date_1</span><span class="p">:</span><span class="n">STRING</span><span class="p">)</span><span class="n">s</span> <span class="k">AND</span> <span class="k">CURRENT_DATE</span> 
  <span class="k">AND</span> <span class="o">`</span><span class="n">file</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">project</span><span class="o">`</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">project_1</span><span class="p">:</span><span class="n">STRING</span><span class="p">)</span><span class="n">s</span> 
  <span class="k">AND</span> <span class="o">`</span><span class="n">details</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">installer</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">details</span><span class="p">.</span><span class="n">installer</span><span class="p">.</span><span class="n">name_1</span><span class="p">:</span><span class="n">STRING</span><span class="p">)</span><span class="n">s</span> 
<span class="k">GROUP</span> <span class="k">BY</span> <span class="o">`</span><span class="k">month</span><span class="o">`</span> 
<span class="k">ORDER</span> <span class="k">BY</span> <span class="o">`</span><span class="k">month</span><span class="o">`</span>
</code></pre></div>

<p>To see the actual query with all literals bound to their final values, we need to compile the query first before&nbsp;printing:</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;literal_binds&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span>
</code></pre></div>

<p>to&nbsp;get:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="n">date_trunc</span><span class="p">(</span><span class="nb">date</span><span class="p">(</span><span class="o">`</span><span class="k">timestamp</span><span class="o">`</span><span class="p">),</span> <span class="k">month</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="k">month</span><span class="o">`</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">num_downloads</span><span class="o">`</span> 
<span class="k">FROM</span> <span class="o">`</span><span class="n">bigquery</span><span class="o">-</span><span class="k">public</span><span class="o">-</span><span class="k">data</span><span class="p">.</span><span class="n">pypi</span><span class="p">.</span><span class="n">file_downloads</span><span class="o">`</span> 
<span class="k">WHERE</span> <span class="nb">date</span><span class="p">(</span><span class="o">`</span><span class="k">timestamp</span><span class="o">`</span><span class="p">)</span> <span class="k">BETWEEN</span> <span class="s1">&#39;2021-01-01&#39;</span> <span class="k">AND</span> <span class="k">CURRENT_DATE</span> 
  <span class="k">AND</span> <span class="o">`</span><span class="n">file</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">project</span><span class="o">`</span> <span class="o">=</span> <span class="s1">&#39;pyscaffold&#39;</span> 
  <span class="k">AND</span> <span class="o">`</span><span class="n">details</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">installer</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="o">=</span> <span class="s1">&#39;pip&#39;</span> 
<span class="k">GROUP</span> <span class="k">BY</span> <span class="o">`</span><span class="k">month</span><span class="o">`</span> 
<span class="k">ORDER</span> <span class="k">BY</span> <span class="o">`</span><span class="k">month</span><span class="o">`</span>
</code></pre></div>

<p>But this is only interesting for debugging and also for learning SQLAlchemy. In order to execute the query object and transform
its result set into a dataframe, all we have to do&nbsp;is:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
</code></pre></div>

<p>Quite easy, right? <a href="https://pandas.pydata.org/">Pandas</a> understands and works nicely with SQLAlchemy query objects and&nbsp;engines.</p>
<h2>Conclusion</h2>
<p>We have seen how <span class="caps">SQL</span> string generation in Python programs can be replaced by a programmatic approach and that this
approach has several advantages over the usage of strings. But it also comes with some small downsides. First of all, one
has to learn SQLAlchemy, and its <span class="caps">API</span> as well as documentation is surely not as nice as PySpark. So when switching, you
will become slower for a while until you get the hang of SQLAlchemy. The second downside is that another level of abstraction,
naturally comes with less control over the final <span class="caps">SQL</span> statement, but this is also true for PySpark and a trade-off every developer
always needs to consider. Having mentioned Spark again, my 5 cents are that the PySpark <span class="caps">API</span> is much better than SQLAlchemy 
and if you are using Spark anyway, you should rather use Google&#8217;s <a href="https://github.com/GoogleCloudDataproc/spark-bigquery-connector">Spark Bigquery Connector</a>. For rather small-data projects,
where your Python program just uses BigQuery as data storage, using SQLAlchemy might up your Python code quite a bit&nbsp;though.</p>
<hr>
<p><strong><span class="caps">REMARK</span>: Spark BigQuery Connector and Pushdowns to&nbsp;BigQuery</strong></p>
<p>Right now the <a href="https://github.com/GoogleCloudDataproc/spark-bigquery-connector">Spark Bigquery Connector</a> has no full pushdown capabilities regarding BigQuery. If <code>pushAllFilters</code> is set
to true in <code>spark.conf</code>, which is the default, the connector pushes all the filters Spark can delegate to the BigQuery Storage <span class="caps">API</span>. 
Since GroupBy is a more complex operation, the following&nbsp;query:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;bigquery&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;bigquery-public-data.pypi.file_downloads&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<p>will first fetch all data from the table into Spark. As this might be quite inefficient it&#8217;s better to directly provide an <span class="caps">SQL</span>
query that filters and groups direclty in BigQuery&nbsp;like:</p>
<div class="highlight"><pre><span></span><code><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;bigquery&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sql_string</span><span class="p">)</span>
</code></pre></div>

<p>In this case, the programmatic SQLAlchemy approach as described above, can also be applied to generate <code>sql_string</code> with the
advantages described&nbsp;above.</p>
<hr>
<p>Feedback is always welcome! Please let me know if this was helpful and also if you think otherwise in the comments&nbsp;below.</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://florianwilhelm.info/2018/07/bridging_the_gap_from_ds_to_prod/">Bridging the Gap: from Data Science to&nbsp;Production</a></li>
        <li><a href="https://florianwilhelm.info/2018/07/how_mobilede_brings_ds_to_prod_for_a_personalized_web_experience/">How mobile.de brings Data Science to Production for a Personalized Web&nbsp;Experience</a></li>
        <li><a href="https://florianwilhelm.info/2018/01/ds_in_prod_packaging_ci/">Data Science in Production: Packaging, Versioning and Continuous&nbsp;Integration</a></li>
        <li><a href="https://florianwilhelm.info/2021/09/Handling_Anaconda_without_getting_constricted/">Handling Anaconda without getting&nbsp;Constricted</a></li>
        <li><a href="https://florianwilhelm.info/2020/05/honey_i_shrunk_the_target_variable/">Honey, I shrunk the target&nbsp;variable</a></li>
    </ul>
</section>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'florianwilhelmblog'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2021-08-08-using_bigquery_with_programmatic_sql';
                        this.page.url = 'https://florianwilhelm.info/2021/08/using_bigquery_with_programmatic_sql/';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://twitter.com/FlorianWilhelm"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
    <li class="list-group-item"><a href="https://linkedin.com/in/florian-wilhelm-621ba834"><i class="fa fa-linkedin-square fa-lg"></i> LinkedIn</a></li>
    <li class="list-group-item"><a href="https://github.com/FlorianWilhelm"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="https://florianwilhelm.info/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/asynchronous/">asynchronous</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/asyncio/">asyncio</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/bayesian/">bayesian</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/big-data/">big data</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/bokeh/">bokeh</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/causal-inference/">causal inference</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://florianwilhelm.info/tag/data-science/">data science</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/deep-learning/">deep learning</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/event-driven/">event-driven</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/gans/">GANs</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/google-hangouts/">google hangouts</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/gps/">gps</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/hadoop/">hadoop</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/hive/">hive</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/jupyter/">jupyter</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/kalman-filter/">kalman filter</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/machine-learning/">machine-learning</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://florianwilhelm.info/tag/mathematics/">mathematics</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/nlp/">nlp</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://florianwilhelm.info/tag/predictive-analytics/">predictive analytics</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/production/">production</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/programming/">programming</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://florianwilhelm.info/tag/python/">Python</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/recommender-systems/">recommender systems</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/scikit-learn/">scikit-learn</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/scipy/">scipy</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/semi-supervised/">semi-supervised</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://florianwilhelm.info/tag/spark/">spark</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/template/">template</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://florianwilhelm.info/tag/uncertainty-quantification/">uncertainty quantification</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2021 Florian Wilhelm
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://florianwilhelm.info/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://florianwilhelm.info/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://florianwilhelm.info/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'florianwilhelmblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-71694209-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


<script>
   $(document).ready(function () {
      $("table").attr("class","table table-condensed table-bordered");
   });
</script>
</body>
</html>